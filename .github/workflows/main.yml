name: Deploy Admin React App

on:
  push:
    branches:
      - main
      - test

jobs: 
  deploy: 
    runs-on: ubuntu-latest
    
    # Set the environment
    environment: ${{ github.ref_name == 'main' && 'prod' || 'test' }}

    env:
      DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
      CPANEL_USER: ${{ secrets.CPANEL_USER }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
    
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Build React App
        run: CI=false npm run build
      
      - name: Check and Prepare Deployment Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USER }}
          key: ${{ secrets.CPANEL_SSH_KEY }}
          script: |
            DEPLOY_PATH="/home/$CPANEL_USER/$DEPLOY_DIR"
            if [ ! -d "$DEPLOY_PATH" ]; then
              mkdir -p "$DEPLOY_PATH"
              echo "Created deployment directory: $DEPLOY_PATH"
            else
              echo "Deployment directory already exists: $DEPLOY_PATH"
            fi
      

      - name: Upload Files to cPanel
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USER }}
          key: ${{ secrets.CPANEL_SSH_KEY }}
          source: build/*
          target: "/home/${{ secrets.CPANEL_USER }}/${{ secrets.DEPLOY_DIR }}"

      - name: Check Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USER }}
          key: ${{ secrets.CPANEL_SSH_KEY }}
          script: |
            DEPLOY_PATH="/home/$CPANEL_USER/$DEPLOY_DIR"
            if [ "$(ls -A "$DEPLOY_PATH")" ]; then
              echo "Deployment successful. Files are present in $DEPLOY_PATH"
            else
              echo "Deployment failed. No files found in $DEPLOY_PATH"
              exit 1
            fi

      - name: Fix Permissions
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USER }}
          key: ${{ secrets.CPANEL_SSH_KEY }}
          script: |
            chmod -R 755 /home/$CPANEL_USER/$DEPLOY_DIR
            echo "Permissions fixed."
            echo "Deployment completed."